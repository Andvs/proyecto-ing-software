{% extends "dashboard_base.html" %}
{% load static %}

{% block titulo %}Asistencia — Listado{% endblock %}

{% block contenido %}
<h2 class="mb-4 text-center">Gestión de Asistencia</h2>

<div class="container py-4">
  <!-- Filtros -->
  <div class="d-flex gap-2 align-items-center mb-3">
    <form class="flex-grow-1" method="get">
      <div class="row g-2">
        <div class="col-lg-5">
          <input
            type="text"
            name="q"
            value="{{ filtros.q|default:filtros.estudiante_q }}"
            class="form-control"
            placeholder="Buscar por estudiante (nombre/usuario)"
          >
        </div>

        <div class="col-lg-2">
          <select name="disciplina" class="form-select">
            <option value="">Disciplina</option>
            {% for d in disciplinas %}
              <option value="{{ d.id }}"
                {% if filtros.disciplina|default:'' == d.id|stringformat:'s' %}selected{% endif %}>
                {{ d.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-lg-2">
          <select name="actividad" class="form-select">
            <option value="">Actividad</option>
            {% for a in actividades %}
              <option value="{{ a.id }}"
                {% if filtros.actividad|default:'' == a.id|stringformat:'s' %}selected{% endif %}>
                {{ a.nombre }} — {{ a.disciplina.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-lg-1">
          <input type="date" name="desde" value="{{ filtros.desde|date:'Y-m-d' }}" class="form-control" title="Desde">
        </div>
        <div class="col-lg-1">
          <input type="date" name="hasta" value="{{ filtros.hasta|date:'Y-m-d' }}" class="form-control" title="Hasta">
        </div>

        <div class="col-lg-1 d-grid">
          <button class="btn btn-primary">Filtrar</button>
        </div>
      </div>
    </form>

    <a href="{% url 'asistencia_seleccionar' %}" class="btn btn-success">
      + Nueva asistencia
    </a>
  </div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Disciplina</th>
            <th>Actividad</th>
            <th>Presentes</th>
            <th>Marcada por</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for s in sesiones %}
            {% with fecha_ymd=s.fecha|date:'Y-m-d' %}
            <tr>
              <td>{{ s.fecha|date:"d-m-Y" }}</td>
              <td>{{ s.actividad.disciplina.nombre }}</td>
              <td>{{ s.actividad.nombre }}</td>
              <td>{{ s.presentes }}</td>
              <td>
                {% if s.marcaje_por %}
                  {{ s.marcaje_por.user.username }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group">
                  <a class="btn btn-sm btn-outline-primary"
                     href="{% url 'asistencia_ver_estudiantes' s.actividad.id fecha_ymd %}">
                    Ver estudiantes
                  </a>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{% url 'asistencia_editar' s.actividad.id fecha_ymd %}">
                    Editar
                  </a>
                  <form action="{% url 'asistencia_toggle_activa' s.actividad.id fecha_ymd %}" method="post"
                        onsubmit="return confirm('¿Seguro que quieres cambiar el estado de esta sesión?');">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    {% if s.activo %}
                      <button class="btn btn-sm btn-outline-warning">Deshabilitar</button>
                    {% else %}
                      <button class="btn btn-sm btn-outline-success">Habilitar</button>
                    {% endif %}
                  </form>

                </div>
              </td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Sin resultados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
